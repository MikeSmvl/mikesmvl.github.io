name: Sentry Release & Deploy

on:
  push:
    tags:
      - 'v*'

jobs:
  sentry:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Sentry CLI
        uses: mathieu-bour/setup-sentry-cli@1.2.0
        with:
          version: latest
          token: ${{ SECRETS.SENTRY_TOKEN }} # from GitHub secrets
          organization: samvelian
          project: personal-website
      - name: Get tag name
        run: echo "tag_name=${{ github.ref_name }}" >> $GITHUB_ENV
      - name: Start release
        run: sentry-cli releases new ${{ env.tag_name }}
      - name: Sync commits
        run: sentry-cli releases set-commits --auto ${{ env.tag_name }}
      - name: Finalise release
        run: sentry-cli releases finalize ${{ env.tag_name }}
      - name: Deploy
        run: sentry-cli releases deploys ${{ env.tag_name }} list
